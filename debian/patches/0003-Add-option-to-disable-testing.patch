From: "Lars T. Kyllingstad" <lars.kyllingstad@sintef.no>
Date: Tue, 28 Feb 2017 10:31:24 +0100
Subject: Add option to disable testing

---
 CMakeLists.txt         | 13 +++++++++----
 src/lib/CMakeLists.txt | 44 +++++++++++++++++++++++---------------------
 2 files changed, 32 insertions(+), 25 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 722e8f9..f0a7223 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -24,6 +24,9 @@ option (CORAL_ENABLE_TRACE_LOGGING
 option (FMILIB_USE_SHARED_LIB
         "Whether to link against the shared library version of FMI Library"
         ON)
+option (CORAL_BUILD_TESTS
+        "Whether to build tests"
+        ON)
 
 # ==============================================================================
 # Common variables
@@ -118,10 +121,12 @@ set (versionPatch "${CMAKE_MATCH_1}")
 # whatnot.  (Otherwise it would be defined in proto/CMakeLists.txt.)
 cmake_policy (SET CMP0022 NEW)
 
-# Enable testing and load Google Test
-enable_testing ()
-set (gtest_force_shared_crt ON CACHE INTERNAL "Google Test setting override")
-add_subdirectory ("external/gtest-1.7.0")
+if (CORAL_BUILD_TESTS)
+    # Enable testing and load Google Test
+    enable_testing ()
+    set (gtest_force_shared_crt ON CACHE INTERNAL "Google Test setting override")
+    add_subdirectory ("external/gtest-1.7.0")
+endif ()
 
 # Allow local CMake modules (e.g. find scripts) under cmake/
 list (APPEND CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/cmake")
diff --git a/src/lib/CMakeLists.txt b/src/lib/CMakeLists.txt
index 9f9d149..77bcdab 100644
--- a/src/lib/CMakeLists.txt
+++ b/src/lib/CMakeLists.txt
@@ -176,24 +176,26 @@ endif()
 install (TARGETS ${_target} EXPORT ${exportTarget} ${targetInstallDestinations})
 
 # Test target
-set (_testTarget "${_target}_test")
-add_executable (${_testTarget} ${_testSources})
-target_link_libraries (${_testTarget}
-    PRIVATE ${_target}
-            "gtest_main"
-            ${FMILIB_LIBRARIES}
-            ${CPPZMQ_LIBRARIES}
-            "boost"
-)
-# FindBoost uses "old style" library references
-target_include_directories(${_testTarget}
-    PRIVATE "$<TARGET_PROPERTY:gtest_main,INCLUDE_DIRECTORIES>"
-            $<TARGET_PROPERTY:coralproto,INTERFACE_INCLUDE_DIRECTORIES>
-)
-target_compile_definitions(${_testTarget} PRIVATE
-    "CORAL_TEST_FMU_DIRECTORY=${CMAKE_SOURCE_DIR}/external/fmus"
-)
-add_test (NAME ${_testTarget} COMMAND ${_testTarget})
-set_tests_properties(${_testTarget} PROPERTIES
-    ENVIRONMENT "CORAL_TEST_DATA_DIR=${CMAKE_SOURCE_DIR}/test_data"
-)
+if (CORAL_BUILD_TESTS)
+    set (_testTarget "${_target}_test")
+    add_executable (${_testTarget} ${_testSources})
+    target_link_libraries (${_testTarget}
+        PRIVATE ${_target}
+                "gtest_main"
+                ${FMILIB_LIBRARIES}
+                ${CPPZMQ_LIBRARIES}
+                "boost"
+    )
+    # FindBoost uses "old style" library references
+    target_include_directories(${_testTarget}
+        PRIVATE "$<TARGET_PROPERTY:gtest_main,INCLUDE_DIRECTORIES>"
+                $<TARGET_PROPERTY:coralproto,INTERFACE_INCLUDE_DIRECTORIES>
+    )
+    target_compile_definitions(${_testTarget} PRIVATE
+        "CORAL_TEST_FMU_DIRECTORY=${CMAKE_SOURCE_DIR}/external/fmus"
+    )
+    add_test (NAME ${_testTarget} COMMAND ${_testTarget})
+    set_tests_properties(${_testTarget} PROPERTIES
+        ENVIRONMENT "CORAL_TEST_DATA_DIR=${CMAKE_SOURCE_DIR}/test_data"
+    )
+endif ()
